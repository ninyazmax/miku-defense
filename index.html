<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miku Defense - Tower Defense</title>
    <style>
        :root {
            --primary-color: #6a5acd;
            --secondary-color: #9370db;
            --accent-color: #ff69b4;
            --text-color: #ffffff;
            --background-dark: #1a1a2e;
            --button-hover: #7b68ee;
            --health-color: #ff4444;
            --coin-color: #ffd700;
            --path-color: #8b4513;
            --grass-color: #2e8b57;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Press Start 2P', cursive;
        }

        body {
            background-color: var(--background-dark);
            color: var(--text-color);
            overflow: hidden;
        }

        /* Menú Principal */
        .main-menu {
            position: fixed;
            width: 100%;
            height: 100%;
            background: url('https://i.pinimg.com/originals/4c/23/98/4c2398e6be397bb08b5cb70b2192d730.gif') no-repeat center center;
            background-size: cover;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .menu-title {
            font-size: 3rem;
            margin-bottom: 2rem;
            text-shadow: 4px 4px 0px #000;
            color: var(--accent-color);
            animation: pulse 2s infinite;
        }

        .menu-button {
            background-color: var(--primary-color);
            color: white;
            border: 3px solid black;
            padding: 1rem 2rem;
            margin: 0.5rem;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            box-shadow: 5px 5px 0px rgba(0, 0, 0, 0.5);
        }

        .menu-button:hover {
            background-color: var(--button-hover);
            transform: translate(-2px, -2px);
            box-shadow: 7px 7px 0px rgba(0, 0, 0, 0.5);
        }

        .menu-button:active {
            transform: translate(0, 0);
            box-shadow: 3px 3px 0px rgba(0, 0, 0, 0.5);
        }

        /* lobby */
        .lobby-container {
            display: none;
            position: fixed;
            width: 100%;
            height: 100%;
            background: url('https://i.pinimg.com/originals/71/f1/b9/71f1b924a56150104ec16828f2d31b7f.gif') no-repeat center center;
            background-size: cover;
            z-index: 90;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .room-code {
            font-size: 2rem;
            margin-bottom: 1rem;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 1rem;
            border: 3px solid var(--accent-color);
        }

        .player-list {
            display: flex;
            margin-bottom: 2rem;
        }

        .player-slot {
            width: 100px;
            height: 120px;
            background-color: rgba(0, 0, 0, 0.5);
            margin: 0 0.5rem;
            border: 2px dashed var(--text-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .player-avatar {
            width: 64px;
            height: 64px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            margin-bottom: 0.5rem;
        }

        .player-name {
            font-size: 0.8rem;
            text-align: center;
        }

        /* Juego */
        .game-container {
            display: none;
            width: 100%;
            height: 100vh;
            position: relative;
        }

        .game-map {
            width: 100%;
            height: 80%;
            background: url('https://i.sstatic.net/BFjwi.png') no-repeat center center;
            background-size: contain;
            position: relative;
            overflow: hidden;
        }

        .path {
            position: absolute;
            background-color: var(--path-color);
            opacity: 0.5;
        }

        .tower-spot {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 1px dashed rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            cursor: pointer;
        }

        .tower {
            position: absolute;
            width: 32px;
            height: 32px;
            transform: translate(-50%, -50%);
            z-index: 10;
            cursor: move;
        }

        .tower.miku {
            background-color: #39c5bb;
            border: 2px solid black;
            border-radius: 50%;
        }

        .tower.teto {
            background-color: #ff9ec6;
            border: 2px solid black;
            border-radius: 50%;
        }

        .tower.neru {
            background-color: #ffcc22;
            border: 2px solid black;
            border-radius: 50%;
        }

        .projectile {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            z-index: 5;
        }

        .enemy {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            z-index: 8;
            transform: translate(-50%, -50%);
        }

        /* UI */
        .game-ui {
            width: 100%;
            height: 20%;
            background-color: var(--background-dark);
            border-top: 3px solid var(--primary-color);
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
        }

        .health-display, .coin-display {
            display: flex;
            align-items: center;
            font-size: 1.2rem;
        }

        .health-icon {
            color: var(--health-color);
            margin-right: 0.5rem;
        }

        .coin-icon {
            color: var(--coin-color);
            margin-right: 0.5rem;
        }

        .tower-select {
            display: flex;
        }

        .tower-option {
            width: 50px;
            height: 50px;
            margin: 0 0.5rem;
            border: 2px solid black;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .tower-option:hover {
            transform: scale(1.1);
        }

        .tower-option.miku {
            background-color: #39c5bb;
        }

        .tower-option.teto {
            background-color: #ff9ec6;
        }

        .tower-option.neru {
            background-color: #ffcc22;
        }

        .tower-cost {
            position: absolute;
            bottom: -15px;
            font-size: 0.7rem;
            color: var(--coin-color);
        }

        .upgrade-panel {
            position: absolute;
            right: 10px;
            top: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 1rem;
            border: 2px solid var(--primary-color);
            display: none;
        }

        .upgrade-option {
            margin: 0.5rem 0;
            cursor: pointer;
        }

        /* Animaciones */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }

        /* Créditos pantalla tipo lobby */
        .credits-container {
            display: none;
            position: fixed;
            width: 100vw;
            height: 100vh;
            background: url('https://i.pinimg.com/originals/4c/23/98/4c2398e6be397bb08b5cb70b2192d730.gif') no-repeat center center;
            background-size: cover;
            z-index: 200;
            overflow: hidden;
            justify-content: center;
            align-items: center;
        }
        .credits-scroll-area {
            position: absolute;
            left: 0; right: 0; top: 0; bottom: 0;
            width: 100vw;
            height: 100vh;
            overflow-y: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
        }
        .credits-rolling {
            position: relative;
            width: 600px;
            max-width: 90vw;
            margin: 0 auto;
            padding: 60px 0 60px 0;
            color: #fff;
            font-size: 1.1rem;
            text-align: center;
            z-index: 2;
        }
        .credits-title {
            font-size: 2.2rem;
            color: var(--accent-color);
            margin-bottom: 1.5rem;
            text-shadow: 2px 2px 0 #000;
        }
        .credits-section {
            margin-bottom: 1.2rem;
        }
        .credits-section strong {
            color: var(--primary-color);
        }
        .credits-list {
            margin: 0.5rem 0 0 0;
            padding: 0;
            list-style: none;
            font-size: 1rem;
        }
        .credits-btn {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 30px;
            background: var(--accent-color);
            color: #fff;
            border: 2px solid #000;
            border-radius: 8px;
            padding: 0.7rem 2.2rem;
            font-size: 1.1rem;
            cursor: pointer;
            font-family: inherit;
            transition: background 0.2s, transform 0.2s;
            z-index: 10;
        }
        .credits-btn:hover {
            background: var(--button-hover);
            transform: translateX(-50%) scale(1.05);
        }
        .credits-side-img {
            position: absolute;
            width: 140px;
            height: 140px;
            object-fit: cover;
            border-radius: 18px;
            border: 3px solid var(--primary-color);
            box-shadow: 0 0 18px #000a;
            z-index: 1;
            opacity: 0.92;
            background: #222;
        }
        .credits-side-img.left {
            left: 30px;
            top: 20%;
        }
        .credits-side-img.right {
            right: 30px;
            top: 60%;
        }
        .credits-side-img2 {
            position: absolute;
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 18px;
            border: 2px solid var(--accent-color);
            box-shadow: 0 0 10px #000a;
            z-index: 1;
            opacity: 0.92;
            background: #222;
        }
        .credits-side-img2.left {
            left: 40px;
            top: 65%;
        }
        .credits-side-img2.right {
            right: 40px;
            top: 30%;
        }
        /* Fondo oscuro para mejorar legibilidad */
        .credits-bg {
            position: absolute;
            left: 0; top: 0; right: 0; bottom: 0;
            background: rgba(26,26,46,0.82);
            z-index: 0;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Menú Principal -->
    <div class="main-menu" id="mainMenu">
        <h1 class="menu-title floating">Miku Defense</h1>
        <button class="menu-button" id="createRoomBtn">Crear Sala</button>
        <button class="menu-button" id="joinRoomBtn">Entrar a Sala</button>
        <button class="menu-button" id="profileBtn">Perfil</button>
        <button class="menu-button" id="shopBtn">Tienda</button>
        <button class="menu-button" id="settingsBtn">Configuración</button>
        <button class="menu-button" id="creditsBtn">Créditos</button>
    </div>

    <!-- Lobby -->
    <div class="lobby-container" id="lobbyContainer">
        <h2>Sala de Espera</h2>
        <div class="room-code" id="roomCodeDisplay">Código: ABCD12</div>
        <div class="player-list">
            <div class="player-slot">
                <div class="player-avatar"></div>
                <div class="player-name" id="player1Name">Jugador 1</div>
            </div>
            <div class="player-slot">
                <div class="player-avatar"></div>
                <div class="player-name" id="player2Name">Esperando...</div>
            </div>
            <div class="player-slot">
                <div class="player-avatar"></div>
                <div class="player-name" id="player3Name">Esperando...</div>
            </div>
        </div>
        <button class="menu-button" id="startGameBtn">Iniciar Juego</button>
        <button class="menu-button" id="leaveLobbyBtn">Salir del Lobby</button>
    </div>

    <!-- Juego -->
    <div class="game-container" id="gameContainer">
        <div class="game-map" id="gameMap">
            <!-- El camino se generará dinámicamente -->
            <!-- Las torres y enemigos se añadirán dinámicamente -->
        </div>
        <div class="game-ui">
            <div class="health-display">
                <span class="health-icon">❤️</span>
                <span id="healthCount">100</span>
            </div>
            <div class="tower-select">
                <div class="tower-option miku" data-tower="miku">
                    Miku
                    <div class="tower-cost">$100</div>
                </div>
                <div class="tower-option teto" data-tower="teto">
                    Teto
                    <div class="tower-cost">$150</div>
                </div>
                <div class="tower-option neru" data-tower="neru">
                    Neru
                    <div class="tower-cost">$200</div>
                </div>
            </div>
            <div class="coin-display">
                <span class="coin-icon">🪙</span>
                <span id="coinCount">500</span>
            </div>
        </div>
        <div class="upgrade-panel" id="upgradePanel">
            <h3>Mejoras</h3>
            <div class="upgrade-option" data-upgrade="damage">Daño (+10%) - $100</div>
            <div class="upgrade-option" data-upgrade="speed">Velocidad (+10%) - $100</div>
            <div class="upgrade-option" data-upgrade="range">Rango (+10%) - $100</div>
            <div class="upgrade-option" data-upgrade="special">Ataque Especial - $300</div>
        </div>
    </div>

    <!-- Modal de Perfil -->
    <div class="modal" id="profileModal" style="display: none;">
        <h2>Perfil</h2>
        <input type="text" id="playerNameInput" placeholder="Tu nombre">
        <button id="saveProfileBtn">Guardar</button>
    </div>

    <!-- Créditos pantalla tipo lobby con animación y scroll -->
    <div class="credits-container" id="creditsContainer">
        <div class="credits-bg"></div>
        <!-- Imágenes laterales, cambia src por tus URLs -->
        <img class="credits-side-img left" src="https://i.imgur.com/9QeQK6v.png" alt="Miku" title="Miku (puedes cambiar la URL)">
        <img class="credits-side-img right" src="https://i.imgur.com/8bFQK6v.png" alt="Teto" title="Teto (puedes cambiar la URL)">
        <img class="credits-side-img2 left" src="https://i.imgur.com/6QeQK6v.png" alt="Neru" title="Neru (puedes cambiar la URL)">
        <img class="credits-side-img2 right" src="https://i.imgur.com/7QeQK6v.png" alt="Mapa" title="Mapa (puedes cambiar la URL)">
        <div class="credits-scroll-area" id="creditsScrollArea">
            <div class="credits-rolling" id="creditsRolling">
                <div class="credits-title">Créditos</div>
                <div class="credits-section">
                    <strong>Desarrollador Principal:</strong>
                    <ul class="credits-list">
                        <li>Steven (Programación, Diseño, UI)</li>
                    </ul>
                </div>
                <div class="credits-section">
                    <strong>Música:</strong>
                    <ul class="credits-list">
                        <li>Eliezer Beltran</li>
                        <li>DECO*27 - Ghost Rule (Remix)</li>
                        <li>kz(livetune) - Tell Your World</li>
                    </ul>
                </div>
                <div class="credits-section">
                    <strong>Sprites y Arte:</strong>
                    <ul class="credits-list">
                        <li>Adonis Enrique (Miku, Teto, Neru)</li>
                        <li>OpenGameArt.org (Tiles, Enemigos)</li>
                    </ul>
                </div>
                <div class="credits-section">
                    <strong>Inspiraciones:</strong>
                    <ul class="credits-list">
                        <li>mesmerizer fan-made-game</li>
                        <li>juegos de tower defense como:</li>
                        <li>bloons TD battle 5 y 6</li>
                        <li>toys tower defense</li>
                    </ul>
                </div>
                <div class="credits-section">
                    <strong>Recursos y Librerías:</strong>
                    <ul class="credits-list">
                        <li>Google Fonts: Press Start 2P</li>
                        <li>Stack Overflow (ayuda en lógica y bugs)</li>
                        <li>JavaScript Vanilla</li>
                        <li>HTML5 + CSS3</li>
                    </ul>
                </div>
                <div class="credits-section">
                    <strong>Características del Juego:</strong>
                    <ul class="credits-list">
                        <li>Multijugador local simulado (lobby, salas)</li>
                        <li>Oleadas de enemigos y torres mejorables</li>
                        <li>Interfaz inspirada en Vocaloid y juegos retro</li>
                        <li>Animaciones y efectos visuales personalizados</li>
                        <li>Panel de mejoras para torres</li>
                        <li>Diseño responsivo y controles intuitivos</li>
                    </ul>
                </div>
                <div class="credits-section">
                    <strong>Contacto y Redes:</strong>
                    <ul class="credits-list">
                        <li>GitHub: <a href="#" style="color:#ffd700;">[Tu GitHub]</a></li>
                        <li>Twitter: <a href="#" style="color:#ffd700;">[Tu Twitter]</a></li>
                        <li>Discord: <a href="#" style="color:#ffd700;">[Tu Discord]</a></li>
                    </ul>
                </div>
                <div class="credits-section">
                    <strong>Agradecimientos Especiales:</strong>
                    <ul class="credits-list">
                        <li>Comunidad Vocaloid</li>
                        <li>Amigos y testers</li>
                        <li>Usuarios que apoyaron el desarrollo</li>
                    </ul>
                </div>
                <div class="credits-section" style="margin-top:2.5rem;">
                    <em>¡Gracias por jugar Miku Defense!</em>
                </div>
            </div>
        </div>
        <button class="credits-btn" id="closeCreditsBtn2">Volver al Menú</button>
    </div>

    <!-- Modal de Créditos (antiguo, ahora oculto) -->
    <div class="modal" id="creditsModal" style="display: none;">
        <h2>Créditos</h2>
        <p>Desarrollado por [Tu Nombre]</p>
        <p>Música: [Artistas/Canción]</p>
        <p>Sprites: [Artistas]</p>
        <button id="closeCreditsBtn">Cerrar</button>
    </div>

    <script>
        // Variables del juego
        let gameState = 'menu'; // menu, lobby, game
        let selectedTower = null;
        let coins = 500;
        let health = 100;
        let currentWave = 0;
        let enemies = [];
        let towers = [];
        let projectiles = [];
        let playerName = "Jugador";
        let roomCode = "";
        let players = [];

        // Elementos del DOM
        const mainMenu = document.getElementById('mainMenu');
        const lobbyContainer = document.getElementById('lobbyContainer');
        const gameContainer = document.getElementById('gameContainer');
        const gameMap = document.getElementById('gameMap');
        const healthCount = document.getElementById('healthCount');
        const coinCount = document.getElementById('coinCount');
        const roomCodeDisplay = document.getElementById('roomCodeDisplay');
        const player1Name = document.getElementById('player1Name');
        const player2Name = document.getElementById('player2Name');
        const player3Name = document.getElementById('player3Name');
        const upgradePanel = document.getElementById('upgradePanel');

        // Configuración del mapa
        const path = [
            {x: 0, y: 200}, {x: 200, y: 200}, {x: 200, y: 400}, 
            {x: 400, y: 400}, {x: 400, y: 100}, {x: 600, y: 100},
            {x: 600, y: 300}, {x: 800, y: 300}, {x: 800, y: 500}
        ];

        // Inicialización del juego
        function init() {
            // Event listeners para los botones del menú
            document.getElementById('createRoomBtn').addEventListener('click', createRoom);
            document.getElementById('joinRoomBtn').addEventListener('click', joinRoom);
            document.getElementById('profileBtn').addEventListener('click', showProfile);
            document.getElementById('shopBtn').addEventListener('click', showShop);
            document.getElementById('settingsBtn').addEventListener('click', showSettings);
            document.getElementById('creditsBtn').addEventListener('click', showCredits);
            document.getElementById('startGameBtn').addEventListener('click', startGame);
            document.getElementById('leaveLobbyBtn').addEventListener('click', leaveLobby);
            document.getElementById('saveProfileBtn').addEventListener('click', saveProfile);
            document.getElementById('closeCreditsBtn').addEventListener('click', closeCredits);
            document.getElementById('closeCreditsBtn2').addEventListener('click', closeCredits);
            
            // Configurar torres seleccionables
            document.querySelectorAll('.tower-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectedTower = this.getAttribute('data-tower');
                });
            });
            
            // Configurar el mapa
            setupMap();
        }

        // Configurar el mapa del juego
        function setupMap() {
            // Dibujar el camino
            for (let i = 0; i < path.length - 1; i++) {
                const start = path[i];
                const end = path[i+1];
                
                const pathSegment = document.createElement('div');
                pathSegment.className = 'path';
                
                if (start.x === end.x) { // Segmento vertical
                    pathSegment.style.left = `${start.x}px`;
                    pathSegment.style.top = `${Math.min(start.y, end.y)}px`;
                    pathSegment.style.width = '40px';
                    pathSegment.style.height = `${Math.abs(end.y - start.y)}px`;
                } else { // Segmento horizontal
                    pathSegment.style.top = `${start.y}px`;
                    pathSegment.style.left = `${Math.min(start.x, end.x)}px`;
                    pathSegment.style.height = '40px';
                    pathSegment.style.width = `${Math.abs(end.x - start.x)}px`;
                }
                
                gameMap.appendChild(pathSegment);
            }
            
            // Crear espacios para torres (simulado)
            for (let i = 0; i < 20; i++) {
                const spot = document.createElement('div');
                spot.className = 'tower-spot';
                spot.style.left = `${100 + Math.random() * 700}px`;
                spot.style.top = `${50 + Math.random() * 450}px`;
                spot.addEventListener('click', placeTower);
                gameMap.appendChild(spot);
            }
            
            // Configurar clic en el mapa para torres
            gameMap.addEventListener('click', function(e) {
                if (selectedTower && e.target === gameMap) {
                    placeTowerAt(e.clientX, e.clientY);
                }
            });
        }

        // Lógica para colocar torres
        function placeTower(e) {
            if (!selectedTower) return;
            
            const spot = e.target;
            const rect = spot.getBoundingClientRect();
            const x = rect.left + rect.width / 2;
            const y = rect.top + rect.height / 2;
            
            placeTowerAt(x, y);
        }

        function placeTowerAt(x, y) {
            const cost = getTowerCost(selectedTower);
            if (coins < cost) return;
            
            coins -= cost;
            updateCoinDisplay();
            
            const tower = document.createElement('div');
            tower.className = `tower ${selectedTower}`;
            tower.style.left = `${x}px`;
            tower.style.top = `${y}px`;
            tower.setAttribute('data-type', selectedTower);
            tower.addEventListener('click', showUpgrades);
            
            gameMap.appendChild(tower);
            
            // Añadir a la lógica del juego
            towers.push({
                element: tower,
                type: selectedTower,
                x: x,
                y: y,
                damage: 10,
                range: 100,
                cooldown: 1000,
                lastShot: 0,
                level: 1
            });
            
            selectedTower = null;
        }

        function getTowerCost(type) {
            switch(type) {
                case 'miku': return 100;
                case 'teto': return 150;
                case 'neru': return 200;
                default: return 0;
            }
        }

        // Mostrar panel de mejoras
        function showUpgrades(e) {
            e.stopPropagation();
            const rect = upgradePanel.getBoundingClientRect();
            upgradePanel.style.display = 'block';
            upgradePanel.style.left = `${e.clientX - rect.width / 2}px`;
            upgradePanel.style.top = `${e.clientY - rect.height - 10}px`;
            
            // Encontrar la torre en el array
            const towerElement = e.target;
            const towerIndex = towers.findIndex(t => t.element === towerElement);
            
            // Configurar eventos de mejora
            document.querySelectorAll('.upgrade-option').forEach(option => {
                option.onclick = function() {
                    upgradeTower(towerIndex, this.getAttribute('data-upgrade'));
                    upgradePanel.style.display = 'none';
                };
            });
        }

        // Mejorar torre
        function upgradeTower(index, upgradeType) {
            const tower = towers[index];
            const cost = upgradeType === 'special' ? 300 : 100;
            
            if (coins < cost) return;
            
            coins -= cost;
            updateCoinDisplay();
            
            switch(upgradeType) {
                case 'damage':
                    tower.damage *= 1.1;
                    break;
                case 'speed':
                    tower.cooldown *= 0.9;
                    break;
                case 'range':
                    tower.range *= 1.1;
                    break;
                case 'special':
                    if (tower.type === 'teto') {
                        // Ataque múltiple para Teto
                        tower.special = 'multi';
                    } else if (tower.type === 'neru') {
                        // Rayos amarillos para Neru
                        tower.special = 'ray';
                    }
                    break;
            }
            
            tower.level++;
        }

        // Lógica de oleadas de enemigos
        function startWave() {
            currentWave++;
            const enemyCount = 5 + currentWave * 2;
            
            for (let i = 0; i < enemyCount; i++) {
                setTimeout(() => {
                    spawnEnemy();
                }, i * 1000);
            }
        }

        function spawnEnemy() {
            const enemy = document.createElement('div');
            enemy.className = 'enemy';
            enemy.style.backgroundColor = getRandomEnemyColor();
            enemy.style.left = '0px';
            enemy.style.top = `${path[0].y}px`;
            gameMap.appendChild(enemy);
            
            const enemyObj = {
                element: enemy,
                x: 0,
                y: path[0].y,
                health: 50 + currentWave * 10,
                speed: 1 + currentWave * 0.1,
                pathIndex: 0,
                reward: 10 + currentWave * 2
            };
            
            enemies.push(enemyObj);
            
            // Iniciar movimiento
            moveEnemy(enemyObj);
        }

        function getRandomEnemyColor() {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function moveEnemy(enemy) {
            const nextPoint = path[enemy.pathIndex + 1];
            if (!nextPoint) {
                // El enemigo llegó al final
                takeDamage(10);
                removeEnemy(enemy);
                return;
            }
            
            const dx = nextPoint.x - enemy.x;
            const dy = nextPoint.y - enemy.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance < enemy.speed) {
                // Llegó al siguiente punto del camino
                enemy.pathIndex++;
                moveEnemy(enemy);
            } else {
                // Mover hacia el siguiente punto
                enemy.x += (dx / distance) * enemy.speed;
                enemy.y += (dy / distance) * enemy.speed;
                
                enemy.element.style.left = `${enemy.x}px`;
                enemy.element.style.top = `${enemy.y}px`;
                
                requestAnimationFrame(() => moveEnemy(enemy));
            }
        }

        function takeDamage(amount) {
            health -= amount;
            healthCount.textContent = health;
            
            if (health <= 0) {
                gameOver();
            }
        }

        function removeEnemy(enemy) {
            const index = enemies.indexOf(enemy);
            if (index !== -1) {
                enemies.splice(index, 1);
                gameMap.removeChild(enemy.element);
                
                // Recompensa por derrotar enemigo
                coins += enemy.reward;
                updateCoinDisplay();
            }
        }

        function updateCoinDisplay() {
            coinCount.textContent = coins;
        }

        // Lógica de disparo de torres
        function towerLogic(timestamp) {
            towers.forEach(tower => {
                if (timestamp - tower.lastShot > tower.cooldown) {
                    // Buscar enemigo en rango
                    const target = findTarget(tower);
                    if (target) {
                        shoot(tower, target);
                        tower.lastShot = timestamp;
                    }
                }
            });
            
            requestAnimationFrame(towerLogic);
        }

        function findTarget(tower) {
            for (const enemy of enemies) {
                const dx = enemy.x - tower.x;
                const dy = enemy.y - tower.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance <= tower.range) {
                    return enemy;
                }
            }
            return null;
        }

        function shoot(tower, target) {
            const projectile = document.createElement('div');
            projectile.className = 'projectile';
            
            // Color del proyectil según el tipo de torre
            if (tower.type === 'miku') projectile.style.backgroundColor = '#39c5bb';
            else if (tower.type === 'teto') projectile.style.backgroundColor = '#ff9ec6';
            else if (tower.type === 'neru') projectile.style.backgroundColor = '#ffcc22';
            
            projectile.style.left = `${tower.x}px`;
            projectile.style.top = `${tower.y}px`;
            gameMap.appendChild(projectile);
            
            // Animación del proyectil
            const projectileObj = {
                element: projectile,
                x: tower.x,
                y: tower.y,
                target: target,
                damage: tower.damage,
                speed: 5,
                special: tower.special
            };
            
            projectiles.push(projectileObj);
            
            // Efecto de sonido (simulado)
            playSound('shoot');
        }

        function moveProjectiles() {
            projectiles.forEach((proj, index) => {
                const target = proj.target;
                if (!target || !target.element.parentNode) {
                    // El objetivo ya no existe
                    gameMap.removeChild(proj.element);
                    projectiles.splice(index, 1);
                    return;
                }
                
                const dx = target.x - proj.x;
                const dy = target.y - proj.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < proj.speed) {
                    // Impacto
                    target.health -= proj.damage;
                    
                    // Efectos especiales
                    if (proj.special === 'multi' && Math.random() < 0.3) {
                        // Ataque múltiple (Teto)
                        const nearby = enemies.filter(e => e !== target && 
                            Math.abs(e.x - target.x) < 50 && 
                            Math.abs(e.y - target.y) < 50);
                        
                        nearby.slice(0, 2).forEach(e => {
                            e.health -= proj.damage * 0.7;
                        });
                    } else if (proj.special === 'ray') {
                        // Rayo (Neru)
                        const ray = document.createElement('div');
                        ray.style.position = 'absolute';
                        ray.style.left = `${proj.x}px`;
                        ray.style.top = `${proj.y}px`;
                        ray.style.width = `${distance}px`;
                        ray.style.height = '3px';
                        ray.style.backgroundColor = '#ffff00';
                        ray.style.border = '1px solid #000';
                        ray.style.transformOrigin = '0 0';
                        ray.style.transform = `rotate(${Math.atan2(dy, dx)}rad)`;
                        gameMap.appendChild(ray);
                        
                        setTimeout(() => {
                            gameMap.removeChild(ray);
                        }, 100);
                    }
                    
                    if (target.health <= 0) {
                        removeEnemy(target);
                    }
                    
                    gameMap.removeChild(proj.element);
                    projectiles.splice(index, 1);
                } else {
                    // Mover proyectil
                    proj.x += (dx / distance) * proj.speed;
                    proj.y += (dy / distance) * proj.speed;
                    
                    proj.element.style.left = `${proj.x}px`;
                    proj.element.style.top = `${proj.y}px`;
                }
            });
            
            requestAnimationFrame(moveProjectiles);
        }

        function playSound(type) {
            // Implementar lógica de sonido
            console.log(`Playing ${type} sound`);
        }

        function gameOver() {
            alert(`Game Over! Llegaste a la oleada ${currentWave}`);
            resetGame();
        }

        function resetGame() {
            // Limpiar el juego
            enemies.forEach(e => gameMap.removeChild(e.element));
            towers.forEach(t => gameMap.removeChild(t.element));
            projectiles.forEach(p => gameMap.removeChild(p.element));
            
            enemies = [];
            towers = [];
            projectiles = [];
            
            coins = 500;
            health = 100;
            currentWave = 0;
            
            updateCoinDisplay();
            healthCount.textContent = health;
            
            // Volver al menú
            showMainMenu();
        }

        // Funciones de red/multijugador (simuladas)
        function createRoom() {
            roomCode = generateRoomCode();
            roomCodeDisplay.textContent = `Código: ${roomCode}`;
            players = [{name: playerName, id: 'local'}];
            updatePlayerList();
            showLobby();
        }

        function joinRoom() {
            const code = prompt("Ingresa el código de la sala:");
            if (code && code.length === 6) {
                roomCode = code;
                roomCodeDisplay.textContent = `Código: ${roomCode}`;
                players = [
                    {name: "Anfitrión", id: 'host'},
                    {name: playerName, id: 'local'}
                ];
                updatePlayerList();
                showLobby();
            }
        }

        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function updatePlayerList() {
            player1Name.textContent = players[0]?.name || "Esperando...";
            player2Name.textContent = players[1]?.name || "Esperando...";
            player3Name.textContent = players[2]?.name || "Esperando...";
        }

        function startGame() {
            // Simular jugadores adicionales (para prueba)
            if (players.length < 3 && Math.random() > 0.5) {
                players.push({name: "Jugador " + (players.length + 1), id: 'bot'});
                updatePlayerList();
            }
            
            showGame();
            
            // Iniciar lógica del juego
            setTimeout(() => startWave(), 3000);
            requestAnimationFrame(towerLogic);
            requestAnimationFrame(moveProjectiles);
        }

        // Funciones de navegación
        function showMainMenu() {
            mainMenu.style.display = 'flex';
            lobbyContainer.style.display = 'none';
            gameContainer.style.display = 'none';
            gameState = 'menu';
        }

        function showLobby() {
            mainMenu.style.display = 'none';
            lobbyContainer.style.display = 'flex';
            gameContainer.style.display = 'none';
            gameState = 'lobby';
        }

        function showGame() {
            mainMenu.style.display = 'none';
            lobbyContainer.style.display = 'none';
            gameContainer.style.display = 'block';
            gameState = 'game';
        }

        function leaveLobby() {
            roomCode = "";
            players = [];
            showMainMenu();
        }

        function showProfile() {
            document.getElementById('profileModal').style.display = 'block';
            document.getElementById('playerNameInput').value = playerName;
        }

        function saveProfile() {
            playerName = document.getElementById('playerNameInput').value.trim() || "Jugador";
            if (gameState === 'lobby') {
                // Actualizar nombre en el lobby
                const localPlayer = players.find(p => p.id === 'local');
                if (localPlayer) localPlayer.name = playerName;
                updatePlayerList();
            }
            document.getElementById('profileModal').style.display = 'none';
        }

        function showShop() {
            alert("Tienda - En desarrollo");
        }

        function showSettings() {
            alert("Configuración - En desarrollo");
        }

        function showCredits() {
            document.getElementById('creditsContainer').style.display = 'flex';
            const scrollArea = document.getElementById('creditsScrollArea');
            scrollArea.scrollTop = 0;
            creditsPaused = false;
            // Animación automática de scroll hacia arriba
            if (creditsInterval) clearInterval(creditsInterval);
            creditsInterval = setInterval(() => {
                if (!creditsPaused) {
                    scrollArea.scrollTop += 1.2;
                    // Si llegó al final, pausa
                    if (scrollArea.scrollTop + scrollArea.clientHeight >= scrollArea.scrollHeight - 2) {
                        creditsPaused = true;
                    }
                }
            }, 16); // ~60fps
        }

        function closeCredits() {
            document.getElementById('creditsContainer').style.display = 'none';
            if (creditsInterval) clearInterval(creditsInterval);
        }

        // Permitir scroll manual con mouse y pausar animación mientras se interactúa
        window.addEventListener('DOMContentLoaded', () => {
            const scrollArea = document.getElementById('creditsScrollArea');
            let isUserScrolling = false;
            let lastY = 0;

            scrollArea.addEventListener('mousedown', function(e) {
                isUserScrolling = true;
                creditsPaused = true;
                lastY = e.clientY;
            });
            scrollArea.addEventListener('mousemove', function(e) {
                if (isUserScrolling) {
                    scrollArea.scrollTop -= (e.clientY - lastY);
                    lastY = e.clientY;
                }
            });
            scrollArea.addEventListener('mouseup', function() {
                isUserScrolling = false;
                creditsPaused = false;
            });
            scrollArea.addEventListener('mouseleave', function() {
                isUserScrolling = false;
                creditsPaused = false;
            });
            // También pausar animación si el usuario usa la rueda del mouse
            scrollArea.addEventListener('wheel', function() {
                creditsPaused = true;
                setTimeout(() => { creditsPaused = false; }, 1200);
            });
        });

        // Créditos animados y scroll manual
        let creditsInterval = null;
        let creditsPaused = false;

        // Iniciar el juego cuando se cargue la página
        window.onload = init;
    </script>
</body>
</html>
