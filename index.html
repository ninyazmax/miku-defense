<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miku Defense - Tower Defense</title>
    <!-- Incluye la biblioteca de Font Awesome para iconos de juego -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Incluye la biblioteca de Socket.IO para la conexión multijugador -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        :root {
            --primary-color: #6a5acd;
            --secondary-color: #9370db;
            --accent-color: #ff69b4;
            --text-color: #ffffff;
            --background-dark: #1a1a2e;
            --button-hover: #7b68ee;
            --health-color: #ff4444;
            --coin-color: #ffd700;
            --path-color: #8b4513;
            --grass-color: #2e8b57;
        }

        /* Utiliza 'Press Start 2P' para un estilo retro */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Press Start 2P', cursive;
            user-select: none;
        }

        body {
            background-color: var(--background-dark);
            color: var(--text-color);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* Menú Principal */
        .main-menu {
            position: fixed;
            width: 100%;
            height: 100%;
            background: url('https://i.pinimg.com/originals/4c/23/98/4c2398e6be397bb08b5cb70b2192d730.gif') no-repeat center center;
            background-size: cover;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .menu-title {
            font-size: clamp(2rem, 5vw, 3rem);
            margin-bottom: 2rem;
            text-shadow: 4px 4px 0px #000;
            color: var(--accent-color);
            animation: pulse 2s infinite;
        }

        .menu-button {
            background-color: var(--primary-color);
            color: white;
            border: 3px solid black;
            padding: 1rem 2rem;
            margin: 0.5rem;
            font-size: clamp(0.8rem, 2vw, 1.2rem);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            box-shadow: 5px 5px 0px rgba(0, 0, 0, 0.5);
        }

        .menu-button:hover {
            background-color: var(--button-hover);
            transform: translate(-2px, -2px);
            box-shadow: 7px 7px 0px rgba(0, 0, 0, 0.5);
        }

        .menu-button:active {
            transform: translate(0, 0);
            box-shadow: 3px 3px 0px rgba(0, 0, 0, 0.5);
        }

        /* Lobby */
        .lobby-container {
            display: none;
            position: fixed;
            width: 100%;
            height: 100%;
            background: url('https://i.pinimg.com/originals/71/f1/b9/71f1b924a56150104ec16828f2d31b7f.gif') no-repeat center center;
            background-size: cover;
            z-index: 90;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        
        .lobby-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .room-info {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 1rem;
            border: 3px solid var(--accent-color);
            text-shadow: 2px 2px 0px #000;
        }

        .room-code {
            font-size: clamp(1rem, 3vw, 2rem);
            margin-bottom: 0.5rem;
        }
        
        .player-count {
            font-size: clamp(0.8rem, 2vw, 1.2rem);
            color: #ccc;
        }

        .player-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .player-slot {
            width: 120px;
            height: 140px;
            background-color: rgba(0, 0, 0, 0.5);
            margin: 0.5rem;
            border: 2px dashed var(--text-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 0.5rem;
        }

        .player-avatar {
            width: 64px;
            height: 64px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            margin-bottom: 0.5rem;
        }

        .player-name-input {
            width: 100%;
            background: none;
            border: none;
            outline: none;
            text-align: center;
            color: var(--text-color);
            font-family: 'Press Start 2P', cursive;
            font-size: clamp(0.6rem, 1.5vw, 0.8rem);
            padding: 0.2rem;
            cursor: pointer;
        }
        
        .player-name-input:disabled {
            cursor: default;
        }

        /* Modales (perfil, créditos) */
        .modal {
            display: none;
            position: fixed;
            z-index: 101;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--background-dark);
            padding: 2rem;
            border: 3px solid var(--accent-color);
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .modal-content h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .modal-content input {
            width: 100%;
            padding: 0.8rem;
            margin-bottom: 1rem;
            background-color: #333;
            border: 2px solid #555;
            color: white;
            font-family: inherit;
        }

        .modal-content button {
            background-color: var(--primary-color);
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            cursor: pointer;
            font-family: inherit;
        }

        /* Juego */
        .game-container {
            display: none;
            width: 100vw;
            height: 100vh;
            position: relative;
            justify-content: center;
            align-items: center;
        }

        .game-wrapper {
            display: flex;
            border: 5px solid black;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            background-color: #000;
        }
        
        .game-map {
            width: 800px;
            height: 600px;
            background: #2e8b57; /* color base, pero se sobreescribe por el canvas */
            position: relative;
            overflow: hidden;
        }

        #gameCanvas {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .tower {
            position: absolute;
            width: 32px;
            height: 32px;
            transform: translate(-50%, -50%);
            z-index: 10;
            cursor: pointer;
        }
        .tower img {
            width: 100%;
            height: 100%;
            image-rendering: pixelated; /* Para que la imagen se vea pixelada y no borrosa */
        }
        .enemy {
            position: absolute;
            width: 32px; /* Tamaño 32x32 para los enemigos */
            height: 32px;
            z-index: 8;
            transform: translate(-50%, -50%);
            image-rendering: pixelated;
        }
        .projectile {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            z-index: 5;
        }

        /* UI del juego */
        .game-ui {
            width: 200px;
            height: 600px;
            background-color: var(--background-dark);
            border-left: 3px solid var(--primary-color);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 1rem;
        }

        .ui-section {
            width: 100%;
            margin-bottom: 1.5rem;
        }

        .ui-section h3 {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: var(--accent-color);
            text-align: center;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1rem;
            background: #333;
            padding: 0.5rem;
            border-radius: 5px;
            margin-bottom: 0.5rem;
        }

        .tower-select {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .tower-option {
            width: 70px;
            height: 70px;
            border: 2px solid black;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            font-size: 0.8rem;
            transition: transform 0.2s;
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .tower-option img {
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
        }
        
        .tower-option:hover {
            transform: scale(1.1);
        }

        .tower-cost {
            position: absolute;
            bottom: 0;
            background-color: rgba(0,0,0,0.6);
            width: 100%;
            text-align: center;
            font-size: 0.6rem;
            color: var(--coin-color);
            text-shadow: 1px 1px 0px #000;
        }

        .upgrade-panel {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.9);
            padding: 1rem;
            border: 2px solid var(--primary-color);
            display: none;
            z-index: 20;
            box-shadow: 0 0 10px #000;
        }

        .upgrade-panel h3 {
            color: var(--accent-color);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .upgrade-option {
            background-color: #444;
            color: white;
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            font-size: 0.7rem;
            text-align: center;
            transition: background 0.2s;
        }
        
        .upgrade-option:hover {
            background-color: #666;
        }

        /* Animaciones */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }

        .fade-in {
            animation: fadeIn 0.5s forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Menú Principal -->
    <div class="main-menu" id="mainMenu">
        <h1 class="menu-title floating">Miku Defense</h1>
        <button class="menu-button" id="createRoomBtn">Crear Sala</button>
        <button class="menu-button" id="joinRoomBtn">Unirse a Sala</button>
        <button class="menu-button" id="profileBtn">Mi Perfil</button>
        <button class="menu-button" id="shopBtn">Tienda</button>
        <button class="menu-button" id="creditsBtn">Créditos</button>
    </div>

    <!-- Lobby -->
    <div class="lobby-container" id="lobbyContainer">
        <div class="lobby-header">
            <div class="room-info">
                <div class="room-code" id="roomCodeDisplay">Código: ---</div>
                <div class="player-count" id="playerCountDisplay">Jugadores: 0/3</div>
            </div>
        </div>
        <div class="player-list" id="playerList">
            <!-- Los jugadores se renderizarán aquí dinámicamente -->
        </div>
        <button class="menu-button" id="startGameBtn">Iniciar Juego</button>
        <button class="menu-button" id="leaveLobbyBtn">Salir del Lobby</button>
    </div>

    <!-- Juego -->
    <div class="game-container" id="gameContainer">
        <div class="game-wrapper">
            <div class="game-map" id="gameMap">
                <canvas id="gameCanvas"></canvas>
            </div>
            
            <div class="game-ui">
                <div class="ui-section">
                    <h3>Estado</h3>
                    <div class="status-bar">
                        <span>❤️ Vida:</span>
                        <span id="healthCount">100</span>
                    </div>
                    <div class="status-bar">
                        <span>🪙 Monedas:</span>
                        <span id="coinCount">500</span>
                    </div>
                    <div class="status-bar">
                        <span>Ronda:</span>
                        <span id="waveCount">0/20</span>
                    </div>
                </div>

                <div class="ui-section">
                    <h3>Torres</h3>
                    <div class="tower-select">
                        <div class="tower-option" data-tower="miku">
                            <img src="https://placehold.co/70x70/39c5bb/ffffff?text=Miku" alt="Miku" />
                            <div class="tower-cost">$100</div>
                        </div>
                        <div class="tower-option" data-tower="teto">
                            <img src="https://placehold.co/70x70/ff9ec6/ffffff?text=Teto" alt="Teto" />
                            <div class="tower-cost">$150</div>
                        </div>
                        <div class="tower-option" data-tower="neru">
                            <img src="https://placehold.co/70x70/ffcc22/ffffff?text=Neru" alt="Neru" />
                            <div class="tower-cost">$200</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel de mejoras (oculto por defecto) -->
            <div class="upgrade-panel" id="upgradePanel">
                <h3>Mejoras</h3>
                <div class="upgrade-option" data-upgrade="damage">Daño (+10%) - $100</div>
                <div class="upgrade-option" data-upgrade="speed">Velocidad (+10%) - $100</div>
                <div class="upgrade-option" data-upgrade="range">Rango (+10%) - $100</div>
                <div class="upgrade-option" data-upgrade="special">Ataque Especial - $300</div>
            </div>
        </div>
    </div>
    
    <!-- Modales para Perfil, Unirse y Créditos -->
    <div class="modal" id="profileModal">
        <div class="modal-content">
            <h2>Mi Perfil</h2>
            <input type="text" id="playerNameInput" placeholder="Tu nombre" maxlength="12">
            <button id="saveProfileBtn">Guardar</button>
        </div>
    </div>
    
    <div class="modal" id="joinRoomModal">
        <div class="modal-content">
            <h2>Unirse a una Sala</h2>
            <input type="text" id="roomCodeInput" placeholder="Código de la sala" maxlength="6">
            <button id="joinRoomConfirmBtn">Unirse</button>
            <button id="closeJoinRoomBtn">Cancelar</button>
        </div>
    </div>

    <div class="modal" id="creditsModal">
        <div class="modal-content">
            <h2>Créditos</h2>
            <p><strong>Desarrollado por:</strong> [Tu Nombre]</p>
            <p><strong>Arte y Diseño:</strong> [Colaborador 1]</p>
            <p><strong>Música:</strong> [Colaborador 2]</p>
            <button id="closeCreditsBtn">Cerrar</button>
        </div>
    </div>

    <script>
        // Variables del juego
        let gameState = 'menu'; // menu, lobby, game
        let selectedTower = null;
        let coins = 500;
        let health = 100;
        let currentWave = 0;
        let enemies = [];
        let towers = [];
        let projectiles = [];
        let playerName = "Jugador";
        let roomCode = null;
        let players = [];
        let socket = null;
        let isGameActive = false;
        
        // Sprites de las torres (debes reemplazar estas URLs con tus propias imágenes PNG)
        // Puedes usar una herramienta como https://www.piskelapp.com/ para crearlas
        const towerSprites = {
            miku_down: 'https://placehold.co/32x32/39c5bb/ffffff?text=Miku+Down',
            miku_up: 'https://placehold.co/32x32/39c5bb/ffffff?text=Miku+Up',
            teto_down: 'https://placehold.co/32x32/ff9ec6/ffffff?text=Teto+Down',
            teto_up: 'https://placehold.co/32x32/ff9ec6/ffffff?text=Teto+Up',
            neru_down: 'https://placehold.co/32x32/ffcc22/ffffff?text=Neru+Down',
            neru_up: 'https://placehold.co/32x32/ffcc22/ffffff?text=Neru+Up',
        };

        // Elementos del DOM
        const mainMenu = document.getElementById('mainMenu');
        const lobbyContainer = document.getElementById('lobbyContainer');
        const gameContainer = document.getElementById('gameContainer');
        const gameMap = document.getElementById('gameMap');
        const healthCount = document.getElementById('healthCount');
        const coinCount = document.getElementById('coinCount');
        const waveCount = document.getElementById('waveCount');
        const roomCodeDisplay = document.getElementById('roomCodeDisplay');
        const playerCountDisplay = document.getElementById('playerCountDisplay');
        const playerList = document.getElementById('playerList');
        const upgradePanel = document.getElementById('upgradePanel');
        const gameCanvas = document.getElementById('gameCanvas');
        const ctx = gameCanvas.getContext('2d');

        // Configuración del juego
        const MAP_WIDTH = 800;
        const MAP_HEIGHT = 600;
        const TILE_SIZE = 16;
        const MAX_WAVES = 20;

        gameCanvas.width = MAP_WIDTH;
        gameCanvas.height = MAP_HEIGHT;
        gameMap.style.width = `${MAP_WIDTH}px`;
        gameMap.style.height = `${MAP_HEIGHT}px`;

        // NUEVO: Coordenadas del camino para el mapa pixel art.
        // El camino está definido por puntos que el enemigo seguirá.
        const path = [
            { x: 10, y: 300 },
            { x: 200, y: 300 },
            { x: 200, y: 100 },
            { x: 450, y: 100 },
            { x: 450, y: 500 },
            { x: 600, y: 500 },
            { x: 600, y: 250 },
            { x: 790, y: 250 }
        ];

        // Lógica de inicialización
        window.onload = function() {
            init();
        }

        function init() {
            setupEventListeners();
            connectToServer();
            showMainMenu(); // Asegura que el menú principal sea visible al inicio
        }

        function setupEventListeners() {
            document.getElementById('createRoomBtn').addEventListener('click', createRoom);
            document.getElementById('joinRoomBtn').addEventListener('click', () => {
                document.getElementById('joinRoomModal').style.display = 'flex';
            });
            document.getElementById('joinRoomConfirmBtn').addEventListener('click', joinRoom);
            document.getElementById('closeJoinRoomBtn').addEventListener('click', () => {
                document.getElementById('joinRoomModal').style.display = 'none';
            });
            document.getElementById('profileBtn').addEventListener('click', showProfile);
            document.getElementById('saveProfileBtn').addEventListener('click', saveProfile);
            document.getElementById('shopBtn').addEventListener('click', () => showMessage("Tienda - En desarrollo"));
            document.getElementById('creditsBtn').addEventListener('click', showCredits);
            document.getElementById('closeCreditsBtn').addEventListener('click', closeCredits);
            document.getElementById('startGameBtn').addEventListener('click', startGame);
            document.getElementById('leaveLobbyBtn').addEventListener('click', leaveLobby);
            
            document.querySelectorAll('.tower-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectedTower = this.getAttribute('data-tower');
                });
            });
            
            gameMap.addEventListener('click', function(e) {
                if (gameState === 'game' && selectedTower) {
                    const rect = gameCanvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    placeTowerAt(x, y);
                }
            });

            document.addEventListener('click', (e) => {
                if (e.target.closest('.tower') === null) {
                    upgradePanel.style.display = 'none';
                }
            });
        }
        
        // ---- LÓGICA DE MULTIJUGADOR (CLIENTE) CON SOCKET.IO ----
        
        function connectToServer() {
            // Reemplaza 'http://localhost:3000' con la URL de tu servidor
            // Si el juego está en GitHub Pages, necesitarás un servidor alojado
            // en otro lugar.
            socket = io('http://localhost:3000'); 

            // Maneja la conexión exitosa
            socket.on('connect', () => {
                console.log('Conectado al servidor Socket.IO.');
            });

            // Maneja la desconexión
            socket.on('disconnect', () => {
                console.log('Desconectado del servidor.');
                if (gameState !== 'menu') {
                    showMessage("Conexión perdida. Vuelve al menú principal.");
                    resetGame(); // Resetear el estado del juego
                    showMainMenu(); // Mostrar el menú principal
                }
            });

            // Recibe la lista de jugadores actualizada
            socket.on('update-lobby', (data) => {
                players = data.players;
                roomCode = data.roomCode;
                updateLobbyUI();
            });

            // El servidor nos confirma que la sala se ha creado
            socket.on('room-created', (data) => {
                roomCode = data.roomCode;
                players = [{ id: socket.id, name: playerName }];
                showLobby();
            });

            // El servidor nos confirma que nos hemos unido a una sala
            socket.on('room-joined', (data) => {
                roomCode = data.roomCode;
                players = data.players;
                showLobby();
            });

            // El servidor nos dice que el juego ha comenzado
            socket.on('game-start', (data) => {
                // Aquí podrías recibir el estado inicial del juego, si fuera necesario
                showGame();
                startGameLogic();
            });

            // El servidor nos envía actualizaciones del estado del juego
            socket.on('game-state-update', (data) => {
                // Sincroniza el estado del juego (enemigos, salud, etc.)
                // Esto es crucial para el multijugador
                // Por ahora, lo mantenemos simple.
            });
        }
        
        function createRoom() {
            if (socket && socket.connected) {
                showMessage("Creando sala...");
                socket.emit('create-room', { playerName });
            } else {
                showMessage("No hay conexión con el servidor. Intenta de nuevo más tarde.");
            }
        }
        
        function joinRoom() {
            const code = document.getElementById('roomCodeInput').value.trim();
            if (code && code.length === 6 && socket && socket.connected) {
                showMessage("Intentando unirse a la sala...");
                socket.emit('join-room', { roomCode: code, playerName });
            } else {
                showMessage("Código de sala inválido o no hay conexión.");
            }
        }

        function leaveLobby() {
            if (socket && socket.connected) {
                socket.emit('leave-room', { roomCode });
            }
            roomCode = null;
            players = [];
            showMainMenu();
        }

        function startGame() {
            if (socket && socket.connected) {
                socket.emit('start-game', { roomCode });
            }
        }

        // --- Fin de la lógica de Socket.IO ---

        // Dibuja el nuevo mapa pixel art
        function drawMap() {
            ctx.clearRect(0, 0, MAP_WIDTH, MAP_HEIGHT);

            // Fondo de pasto con varios tonos
            const grassColors = ["#2a4d34", "#35623e", "#3d6e4a", "#4c8a66"];
            for (let y = 0; y < MAP_HEIGHT; y += 4) {
                for (let x = 0; x < MAP_WIDTH; x += 4) {
                    ctx.fillStyle = grassColors[Math.floor(Math.random() * grassColors.length)];
                    ctx.fillRect(x, y, 4, 4);
                }
            }

            // Dibuja el camino con bordes negros
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(path[0].x, path[0].y);
            for (let i = 1; i < path.length; i++) {
                ctx.lineTo(path[i].x, path[i].y);
            }
            ctx.lineWidth = 40;
            ctx.strokeStyle = "#4b2c1b"; // Borde oscuro
            ctx.stroke();
            
            ctx.lineWidth = 32;
            ctx.strokeStyle = "#8b4513"; // Relleno del camino
            ctx.stroke();

            // Detalles en el mapa (árboles, rocas, etc.)
            // Puedes agregar más detalles con más funciones como estas
            drawPixelArtTree(100, 50, "#22613b", "#3d6e4a");
            drawPixelArtTree(400, 450, "#22613b", "#3d6e4a");
            drawPixelArtTree(700, 150, "#22613b", "#3d6e4a");
            drawPixelArtRock(300, 200, "#666", "#333");
            drawPixelArtRock(650, 400, "#666", "#333");
            drawPixelArtBush(50, 450, "#2a4d34", "#35623e");
            drawPixelArtBush(550, 50, "#2a4d34", "#35623e");
        }

        // Dibuja un árbol de pixel art
        function drawPixelArtTree(x, y, darkColor, lightColor) {
            ctx.save();
            ctx.translate(x, y);

            // Sombra
            ctx.fillStyle = "rgba(0,0,0,0.3)";
            ctx.beginPath();
            ctx.ellipse(16, 40, 12, 5, 0, 0, 2 * Math.PI);
            ctx.fill();

            // Tronco
            ctx.fillStyle = "#a37f5d";
            ctx.fillRect(12, 28, 8, 16);
            ctx.strokeStyle = "#000";
            ctx.lineWidth = 2;
            ctx.strokeRect(12, 28, 8, 16);

            // Copa del árbol
            const crown = [
                [0, 16, 32, 16], [4, 8, 24, 8], [8, 0, 16, 8]
            ];
            for (let i = 0; i < crown.length; i++) {
                const [cx, cy, cw, ch] = crown[i];
                ctx.fillStyle = lightColor;
                ctx.fillRect(cx, cy, cw, ch);
                ctx.strokeStyle = "#000";
                ctx.lineWidth = 1;
                ctx.strokeRect(cx, cy, cw, ch);
            }
            ctx.restore();
        }

        // Dibuja una roca de pixel art
        function drawPixelArtRock(x, y, lightColor, darkColor) {
            ctx.save();
            ctx.translate(x, y);

            // Sombra
            ctx.fillStyle = "rgba(0,0,0,0.3)";
            ctx.beginPath();
            ctx.ellipse(16, 16, 10, 4, 0, 0, 2 * Math.PI);
            ctx.fill();
            
            ctx.fillStyle = lightColor;
            const rockShape = [
                { x: 16, y: 0 }, { x: 30, y: 8 }, { x: 28, y: 20 }, { x: 10, y: 30 }, { x: 2, y: 18 }, { x: 4, y: 6 }
            ];
            ctx.beginPath();
            ctx.moveTo(rockShape[0].x, rockShape[0].y);
            for (let i = 1; i < rockShape.length; i++) {
                ctx.lineTo(rockShape[i].x, rockShape[i].y);
            }
            ctx.closePath();
            ctx.fill();

            ctx.strokeStyle = darkColor;
            ctx.lineWidth = 2;
            ctx.stroke();

            ctx.restore();
        }

        // Dibuja un arbusto de pixel art
        function drawPixelArtBush(x, y, darkColor, lightColor) {
            ctx.save();
            ctx.translate(x, y);

            // Sombra
            ctx.fillStyle = "rgba(0,0,0,0.3)";
            ctx.beginPath();
            ctx.ellipse(12, 24, 10, 4, 0, 0, 2 * Math.PI);
            ctx.fill();

            ctx.fillStyle = darkColor;
            ctx.fillRect(0, 10, 24, 14);
            ctx.fillStyle = lightColor;
            ctx.fillRect(4, 6, 16, 16);
            ctx.fillRect(8, 0, 8, 8);

            ctx.strokeStyle = "#000";
            ctx.lineWidth = 1;
            ctx.strokeRect(0, 10, 24, 14);
            ctx.strokeRect(4, 6, 16, 16);
            ctx.strokeRect(8, 0, 8, 8);
            
            ctx.restore();
        }

        // Dibuja el sprite del enemigo (32x32)
        function drawEnemySprite(ctx, x, y, type) {
            ctx.save();
            ctx.translate(x, y);
            
            ctx.imageSmoothingEnabled = false; // Desactiva el suavizado para el arte pixelado

            if (type === 'slime') {
                ctx.fillStyle = '#00ff00';
                ctx.fillRect(-16, -16, 32, 32);
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.strokeRect(-16, -16, 32, 32);
                ctx.fillStyle = '#000';
                ctx.fillRect(-8, -8, 4, 4);
                ctx.fillRect(4, -8, 4, 4);
                ctx.fillRect(-4, 4, 8, 4);
            } else if (type === 'robot') {
                ctx.fillStyle = '#808080';
                ctx.fillRect(-12, -16, 24, 32);
                ctx.fillStyle = '#ff0000';
                ctx.fillRect(-8, -12, 16, 8);
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.strokeRect(-12, -16, 24, 32);
                ctx.strokeRect(-8, -12, 16, 8);
            }
            ctx.restore();
        }

        // Lógica de juego
        function startGameLogic() {
            isGameActive = true;
            enemies = [];
            towers = [];
            projectiles = [];
            coins = 500;
            health = 100;
            currentWave = 0;
            updateUI();

            drawMap(); // Dibuja el mapa antes de iniciar
            
            setTimeout(() => startWave(), 3000);
            gameLoop();
        }

        function gameLoop() {
            if (!isGameActive) return;

            // Lógica de juego
            moveEnemies();
            towerLogic();
            moveProjectiles();
            
            // Dibuja los elementos en el canvas
            drawMap();
            enemies.forEach(e => drawEnemySprite(ctx, e.x, e.y, e.type));

            requestAnimationFrame(gameLoop);
        }

        // Lógica para colocar torres
        function placeTowerAt(x, y) {
            const cost = getTowerCost(selectedTower);
            if (coins < cost) {
                showMessage("Monedas insuficientes.");
                return;
            }
            
            // Verifica si está en el camino, usando una tolerancia de 25px
            if (isPointOnPath(x, y, 25)) {
                showMessage("No puedes construir en el camino.");
                return;
            }
            
            // Decide qué sprite usar según la posición Y
            const spriteKey = (y > MAP_HEIGHT / 2) ? `${selectedTower}_up` : `${selectedTower}_down`;
            
            const tower = document.createElement('img');
            tower.className = 'tower';
            tower.src = towerSprites[spriteKey];
            tower.style.left = `${x}px`;
            tower.style.top = `${y}px`;
            tower.setAttribute('data-type', selectedTower);
            tower.addEventListener('click', showUpgrades);
            
            gameMap.appendChild(tower);
            
            coins -= cost;
            updateUI();
            
            towers.push({
                element: tower,
                type: selectedTower,
                x: x,
                y: y,
                damage: 10,
                range: 100,
                cooldown: 1000,
                lastShot: 0,
                level: 1
            });
            
            selectedTower = null;
        }

        // Función para verificar si un punto está cerca del camino (ajustada para el nuevo mapa)
        function isPointOnPath(x, y, tolerance) {
            // Esta función es una aproximación y funciona para un camino simple.
            // Para caminos más complejos, se necesitaría una lógica de detección de colisiones más avanzada.
            for (let i = 0; i < path.length - 1; i++) {
                const start = path[i];
                const end = path[i + 1];
                const dx = end.x - start.x;
                const dy = end.y - start.y;
                const len = Math.sqrt(dx * dx + dy * dy);
                if (len === 0) continue;

                const t = Math.max(0, Math.min(1, ((x - start.x) * dx + (y - start.y) * dy) / (len * len)));
                const closestX = start.x + t * dx;
                const closestY = start.y + t * dy;
                const dist = Math.sqrt(Math.pow(x - closestX, 2) + Math.pow(y - closestY, 2));

                if (dist <= tolerance) return true;
            }
            return false;
        }

        function getTowerCost(type) {
            switch(type) {
                case 'miku': return 100;
                case 'teto': return 150;
                case 'neru': return 200;
                default: return 0;
            }
        }
        
        function showUpgrades(e) {
            e.stopPropagation();
            const rect = gameContainer.getBoundingClientRect();
            upgradePanel.style.display = 'block';
            upgradePanel.style.left = `${e.clientX - rect.left}px`;
            upgradePanel.style.top = `${e.clientY - rect.top - upgradePanel.clientHeight - 10}px`;
            
            const towerElement = e.target;
            const towerIndex = towers.findIndex(t => t.element === towerElement);
            
            document.querySelectorAll('.upgrade-option').forEach(option => {
                option.onclick = function() {
                    upgradeTower(towerIndex, this.getAttribute('data-upgrade'));
                    upgradePanel.style.display = 'none';
                };
            });
        }
        
        function upgradeTower(index, upgradeType) {
            const tower = towers[index];
            const cost = upgradeType === 'special' ? 300 : 100;
            
            if (coins < cost) {
                showMessage("Monedas insuficientes para mejorar.");
                return;
            }
            
            coins -= cost;
            updateUI();
            
            switch(upgradeType) {
                case 'damage': tower.damage *= 1.1; break;
                case 'speed': tower.cooldown *= 0.9; break;
                case 'range': tower.range *= 1.1; break;
                case 'special': tower.special = 'active'; break;
            }
            
            tower.level++;
        }

        // Lógica de oleadas de enemigos
        function startWave() {
            if (!isGameActive) return;

            if (currentWave >= MAX_WAVES) {
                showMessage("¡Has ganado el juego!");
                isGameActive = false;
                return;
            }
            currentWave++;
            waveCount.textContent = `${currentWave}/${MAX_WAVES}`;
            const enemyCount = 5 + currentWave * 2;
            
            for (let i = 0; i < enemyCount; i++) {
                setTimeout(() => {
                    spawnEnemy();
                }, i * 1000);
            }
            
            setTimeout(() => {
                startWave();
            }, (enemyCount * 1000) + 5000); 
        }

        function spawnEnemy() {
            if (!isGameActive) return;

            const enemy = document.createElement('div');
            enemy.className = 'enemy';
            
            const enemyObj = {
                element: enemy,
                type: Math.random() > 0.5 ? 'slime' : 'robot',
                x: path[0].x,
                y: path[0].y,
                health: 50 + currentWave * 10,
                speed: 1 + currentWave * 0.1,
                pathIndex: 0,
                reward: 10 + currentWave * 2
            };
            
            enemies.push(enemyObj);
        }

        function moveEnemies() {
            enemies.forEach(enemy => {
                const nextPoint = path[enemy.pathIndex + 1];
                if (!nextPoint) {
                    takeDamage(10);
                    removeEnemy(enemy);
                    return;
                }
                
                const dx = nextPoint.x - enemy.x;
                const dy = nextPoint.y - enemy.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < enemy.speed) {
                    enemy.pathIndex++;
                } else {
                    enemy.x += (dx / distance) * enemy.speed;
                    enemy.y += (dy / distance) * enemy.speed;
                }
            });
        }
        
        function takeDamage(amount) {
            health -= amount;
            if (health <= 0) {
                gameOver();
            }
            updateUI();
        }

        function removeEnemy(enemy) {
            const index = enemies.indexOf(enemy);
            if (index !== -1) {
                enemies.splice(index, 1);
                coins += enemy.reward;
                updateUI();
            }
        }

        // Lógica de disparo de torres
        function towerLogic() {
            towers.forEach(tower => {
                const now = performance.now();
                if (now - tower.lastShot > tower.cooldown) {
                    const target = findTarget(tower);
                    if (target) {
                        shoot(tower, target);
                        tower.lastShot = now;
                    }
                }
            });
        }

        function findTarget(tower) {
            let closestEnemy = null;
            let minDistance = tower.range;
            
            for (const enemy of enemies) {
                const dx = enemy.x - tower.x;
                const dy = enemy.y - tower.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance <= minDistance) {
                    minDistance = distance;
                    closestEnemy = enemy;
                }
            }
            return closestEnemy;
        }

        function shoot(tower, target) {
            const projectile = document.createElement('div');
            projectile.className = 'projectile';
            
            if (tower.type === 'miku') projectile.style.backgroundColor = '#39c5bb';
            else if (tower.type === 'teto') projectile.style.backgroundColor = '#ff9ec6';
            else if (tower.type === 'neru') projectile.style.backgroundColor = '#ffcc22';
            
            projectile.style.left = `${tower.x}px`;
            projectile.style.top = `${tower.y}px`;
            gameMap.appendChild(projectile);
            
            projectiles.push({
                element: projectile,
                x: tower.x,
                y: tower.y,
                target: target,
                damage: tower.damage,
                speed: 5,
                special: tower.special
            });
        }

        function moveProjectiles() {
            projectiles.forEach((proj, index) => {
                const target = proj.target;
                if (!target || !enemies.includes(target)) {
                    if (gameMap.contains(proj.element)) {
                        gameMap.removeChild(proj.element);
                    }
                    projectiles.splice(index, 1);
                    return;
                }
                
                const dx = target.x - proj.x;
                const dy = target.y - proj.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < proj.speed) {
                    target.health -= proj.damage;
                    
                    if (target.health <= 0) {
                        removeEnemy(target);
                    }
                    
                    if (gameMap.contains(proj.element)) {
                        gameMap.removeChild(proj.element);
                    }
                    projectiles.splice(index, 1);
                } else {
                    proj.x += (dx / distance) * proj.speed;
                    proj.y += (dy / distance) * proj.speed;
                    
                    proj.element.style.left = `${proj.x}px`;
                    proj.element.style.top = `${proj.y}px`;
                }
            });
        }

        function gameOver() {
            isGameActive = false;
            showMessage(`¡Game Over! Llegaste a la oleada ${currentWave}`);
            setTimeout(resetGame, 3000);
        }

        function resetGame() {
            enemies.forEach(e => { if (e.element && gameMap.contains(e.element)) gameMap.removeChild(e.element) });
            towers.forEach(t => { if (t.element && gameMap.contains(t.element)) gameMap.removeChild(t.element) });
            projectiles.forEach(p => { if (p.element && gameMap.contains(p.element)) gameMap.removeChild(p.element) });
            
            enemies = [];
            towers = [];
            projectiles = [];
            
            coins = 500;
            health = 100;
            currentWave = 0;
            
            updateUI();
            showMainMenu();
        }

        // Actualiza toda la interfaz de usuario
        function updateUI() {
            healthCount.textContent = health;
            coinCount.textContent = coins;
            waveCount.textContent = `${currentWave}/${MAX_WAVES}`;
            updateLobbyUI();
        }

        function updateLobbyUI() {
            roomCodeDisplay.textContent = `Código: ${roomCode || '---'}`;
            playerCountDisplay.textContent = `Jugadores: ${players.length}/3`;

            // Limpia la lista de jugadores
            playerList.innerHTML = '';
            
            // Renderiza los jugadores en el lobby
            for (let i = 0; i < 3; i++) {
                const slot = document.createElement('div');
                slot.className = 'player-slot';
                const avatar = document.createElement('div');
                avatar.className = 'player-avatar';
                const nameInput = document.createElement('input');
                nameInput.className = 'player-name-input';
                nameInput.type = 'text';
                nameInput.maxLength = 12;

                if (players[i]) {
                    nameInput.value = players[i].name;
                    nameInput.disabled = (players[i].id !== socket.id);
                } else {
                    nameInput.value = "Esperando...";
                    nameInput.disabled = true;
                }
                
                slot.appendChild(avatar);
                slot.appendChild(nameInput);
                playerList.appendChild(slot);
            }
        }
        
        function showMessage(text) {
            const msgBox = document.createElement('div');
            msgBox.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 1rem 2rem;
                border: 2px solid var(--accent-color);
                z-index: 1000;
                font-family: 'Press Start 2P', cursive;
                text-align: center;
                animation: fade-in 0.5s forwards;
            `;
            msgBox.textContent = text;
            document.body.appendChild(msgBox);
            setTimeout(() => {
                msgBox.style.animation = 'fade-out 0.5s forwards';
                setTimeout(() => document.body.removeChild(msgBox), 500);
            }, 2000);
        }

        // Funciones de navegación
        function showMainMenu() {
            mainMenu.style.display = 'flex';
            lobbyContainer.style.display = 'none';
            gameContainer.style.display = 'none';
            document.getElementById('profileModal').style.display = 'none';
            document.getElementById('creditsModal').style.display = 'none';
            document.getElementById('joinRoomModal').style.display = 'none';
            gameState = 'menu';
        }

        function showLobby() {
            mainMenu.style.display = 'none';
            lobbyContainer.style.display = 'flex';
            gameContainer.style.display = 'none';
            document.getElementById('profileModal').style.display = 'none';
            document.getElementById('creditsModal').style.display = 'none';
            document.getElementById('joinRoomModal').style.display = 'none';
            gameState = 'lobby';
        }

        function showGame() {
            mainMenu.style.display = 'none';
            lobbyContainer.style.display = 'none';
            gameContainer.style.display = 'flex';
            document.getElementById('profileModal').style.display = 'none';
            document.getElementById('creditsModal').style.display = 'none';
            document.getElementById('joinRoomModal').style.display = 'none';
            gameState = 'game';
        }

        function showProfile() {
            document.getElementById('playerNameInput').value = playerName;
            document.getElementById('profileModal').style.display = 'flex';
        }
        
        function saveProfile() {
            playerName = document.getElementById('playerNameInput').value.trim() || "Jugador";
            document.getElementById('profileModal').style.display = 'none';
        }
        
        function showCredits() {
            document.getElementById('creditsModal').style.display = 'flex';
        }

        function closeCredits() {
            document.getElementById('creditsModal').style.display = 'none';
        }
    </script>
</body>
</html>
